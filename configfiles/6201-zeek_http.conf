# SOF-ELKÂ® Configuration File
# (C)2023 Lewes Technology Consulting, LLC
#
# This file contains processing steps for Zeek's HTTP logs, normalizing them to existing mappings for other HTTP records
# Some portions orginally contributed by Justin Henderson

# Reference: https://docs.zeek.org/en/master/scripts/base/protocols/http/main.zeek.html#type-HTTP::Info

filter {
  if [type] == "zeek_http" and "zeek_json" in [tags] {
    mutate {
      rename => {
        "[raw][host]" => "hostname"
        "[raw][id.orig_h]" => "[source][ip]"
        "[raw][id.orig_p]" => "[source][port]"
        "[raw][id.resp_h]" => "destination_ip"
        "[raw][id.resp_p]" => "[destination][port]"
        "[raw][info_code]" => "response_code"
        "[raw][info_msg]" => "response_msg"
        "[raw][method]" => "request_method"
        "[raw][orig_filenames]" => "zeek_source_filenames"
        "[raw][orig_fuids]" => "zeek_source_fuids"
        "[raw][orig_mime_types]" => "zeek_source_mime_types"
        "[raw][password]" => "password"
        "[raw][proxied]" => "proxy_headers"
        "[raw][referrer]" => "referrer"
        "[raw][request_body_len]" => "[source][bytes]"
        "[raw][resp_filenames]" => "zeek_destination_filenames"
        "[raw][resp_fuids]" => "zeek_destination_fuids"
        "[raw][resp_mime_depth]" => "zeek_destination_mime_types"
        "[raw][response_body_len]" => "[destination][bytes]"
        "[raw][status_code]" => "response_code"
        "[raw][status_msg]" => "response_phrase"
        "[raw][uid]" => "zeek_uid"
        "[raw][uri]" => "request"
        "[raw][user_agent]" => "useragent"
        "[raw][username]" => "username"
        "[raw][version]" => "httpversion"
      }
    }

    # these are defined by zeek but not handled at this time
    #"trans_depth", "origin", "tags", "capture_password", "range_request"
    #"orig_mime_depth", "resp_mime_depth", "current_entity"

    # populate the @timestamp field with the ts value
    date {
      match => [ "[raw][ts]", "UNIX" ]
    }

    mutate {
      convert => {
        "httpversion" => "float"
        "response_code" => "integer"
        "[source][bytes]" => "integer"
        "[destination][bytes]" => "integer"
      }
      remove_field => "raw"
    }
  }
}
