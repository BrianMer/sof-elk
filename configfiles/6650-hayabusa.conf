# SOF-ELKÂ® Configuration File
# (C)2023 Lewes Technology Consulting, LLC
#
# This file contains processing steps for logs from the Hayabusa tool
# See: https://github.com/Yamato-Security/hayabusa
# Field reference: https://github.com/Yamato-Security/hayabusa#profile-field-aliases

filter {
  if [type] == "hayabusa" {
    # populate the @timestamp field with the Timestamp value
    date {
      match => [ "[raw][Timestamp]", "YYYY-MM-dd HH:mm:ss.SSS ZZ" ]
    }

    mutate {
      rename => {
        "[raw][Computer]" => "computer"
        "[raw][Channel]" => "channel"
        "[raw][EventID]" => "event_id"
        "[raw][Level]" => "level"
        "[raw][RuleTitle]" => "[hayabusa_rule][title]"
        "[raw][RuleAuthor]" => "[hayabusa_rule][author]"
        "[raw][Status]" => "[hayabusa_rule][status]"
        "[raw][RecordID]" => "event_record_id"
        "[raw][Details]" => "event_details"
        "[raw][ExtraFieldInfo]" => "extra_field_info"
        "[raw][Provider]" => "provider"
        "[raw][RuleFile]" => "[hayabusa_rule][file]"
        "[raw][EvtxFile]" => "source_evtx_file"
      }
    }

    if [raw][RuleCreationDate] {
      date {
        match => [ "[raw][RuleCreationDate]", "YYYY/MM/dd" ]
        target => "[hayabusa_rule][created]"
      }
    }
    if [raw][RuleModifiedDate] {
      date {
        match => [ "[raw][RuleModifiedDate]", "YYYY/MM/dd" ]
        target => "[hayabusa_rule][modified]"
      }
    }

    if [event_id] {
      translate {
        dictionary_path => "/usr/local/sof-elk/lib/dictionaries/eventid2desc.yaml"
        source => "[event_id]"
        target => "[event_description]"
      }
    }

    if [event_details][SrcIP] {
      mutate { add_field => { "source_ip" => "%{[event_details][SrcIP]}" } }
    }
    if [event_details][TgtUser] {
      mutate { add_field => { "username" => "%{[event_details][TgtUser]}" } }
    }
    if [extra_field_info][ProcessId] {
      mutate { add_field => { "process_id" => "%{[extra_field_info][ProcessId]}" } }
    }
    if [extra_field_info][ProcessName] {
      mutate { add_field => { "process_name" => "%{[extra_field_info][ProcessName]}" } }
    }
    if [extra_field_info][SubjectUserSid] {
      mutate { add_field => { "subject_user_sid" => "%{[extra_field_info][SubjectUserSid]}" } }
    }
    if [extra_field_info][TargetUserSid] {
      mutate { add_field => { "target_user_sid" => "%{[extra_field_info][TargetUserSid]}" } }
    }
    if [extra_field_info][TargetDomainName] {
      mutate { add_field => { "target_domain_name" => "%{[extra_field_info][TargetDomainName]}" } }
    }
  }
}